# Automate README Updates from Formula Metadata

## Context

GoReleaser in source repos pushes formula update commits directly to this tap's
`main` branch, but the README is manually maintained. The README content
(formula table, install commands, notes) is all derivable from formula files.
This creates drift: for example, `gh-problemas` has "(gh CLI extension)" in the
README but not in the formula `desc`, and `fm` is missing the word "email" in
the README description. The goal is to make formula files the single source of
truth and auto-regenerate README sections on every formula change.

## Approach

Three new/modified files:

1. **`bin/update-readme`** -- shell script that parses `Formula/*.rb`
   and regenerates marked sections of the README
2. **`.github/workflows/update-readme.yml`** -- GitHub Actions workflow
   triggered by formula changes on `main`
3. **`README.md`** -- add HTML comment markers around the three dynamic sections

## Files to Create/Modify

| File | Action |
| --- | --- |
| `README.md` | Add `<!-- BEGIN:section -->` / `<!-- END:section -->` markers |
| `bin/update-readme` | New: formula parser and README generator |
| `.github/workflows/update-readme.yml` | New: CI workflow |

## README Marker Structure

Three marker pairs delimit auto-generated content. Everything outside markers is
preserved exactly.

- `<!-- BEGIN:formulae-table -->` / `<!-- END:formulae-table -->`
- `<!-- BEGIN:install-commands -->` / `<!-- END:install-commands -->`
- `<!-- BEGIN:notes -->` / `<!-- END:notes -->`

## Script Logic (`bin/update-readme`)

### Parsing (per `Formula/*.rb`, sorted alphabetically)

1. **Name**: strip `.rb` from filename
2. **`desc`**: first line matching `^\s*desc "(.+)"`
3. **`homepage`**: first line matching `^\s*homepage "(.+)"`
4. **Formula type** (priority order):
   - HEAD-only: file contains `head "` directive
   - GoReleaser: file contains `# This file was generated by GoReleaser`
   - Pre-built binary: default

### Section Generation

**Formulae table**: Markdown table with `| [`name`](homepage) | description |`
rows.

**Install commands**: Fenced code block with `brew install cboone/tap/name`
lines.

**Notes**: One bullet per formula-type group, with natural language joining:
- Pre-built binary: "installs a pre-built binary from the latest release."
- GoReleaser: "install(s) pre-built binaries from GoReleaser-managed releases."
- HEAD-only: "is a HEAD-only formula that builds from source."

### Replacement

Single `awk` pass handles all three marker pairs: print lines outside markers
unchanged, replace content between each `BEGIN`/`END` pair with the generated
block.

### Modes

- `bin/update-readme` -- update README in place
- `bin/update-readme --check` -- exit 1 if README would change (no
  writes); useful for CI validation

### Edge Cases

- No formula files: warn to stderr, generate empty sections
- Missing `desc`/`homepage`: use fallback, warn to stderr
- Missing marker pair: skip that section, warn to stderr

## GitHub Actions Workflow

```yaml
name: Update README
on:
  push:
    branches: [main]
    paths: ['Formula/*.rb']
permissions:
  contents: write
```

Steps: checkout, run script, check `git diff --quiet README.md`, commit and
push if changed. Uses `github-actions[bot]` identity. Default `GITHUB_TOKEN`
prevents re-triggering (commits from `GITHUB_TOKEN` do not fire workflows).

Commit message: `docs: update README from formula metadata`

## Description Changes

After automation, README descriptions will match formula `desc` fields exactly.
Two current discrepancies will be corrected:

- `fm`: README says "Fastmail via JMAP", formula says "Fastmail email via JMAP"
- `gh-problemas`: README says "(gh CLI extension)", formula omits it

If those README-only embellishments are desired, the `desc` in the source repo's
GoReleaser config should be updated instead.

## Implementation Steps

1. Add HTML comment markers to `README.md` around the three dynamic sections
2. Create `bin/update-readme` (make executable)
3. Test locally: `bash bin/update-readme --check` should show expected
   diff from description corrections, then `bash bin/update-readme`
   should produce the updated file
4. Create `.github/workflows/update-readme.yml`
5. Commit all changes on the feature branch, open PR

## Verification

1. Run `bash bin/update-readme --check` locally and confirm exit code 1
   (due to description corrections from current README)
2. Run `bash bin/update-readme` and inspect the updated README
3. Manually edit a formula's `desc`, run script again, confirm README updates
4. Revert the test edit
5. After merging, the next GoReleaser push will trigger the workflow
